const express = require('express')
const router = express.Router();
const { Spot, ReviewImage, Booking, User, sequelize } = require('../../db/models');
const { restoreUser, requireAuth } = require('../../utils/auth');


const isImageExisting = async (req, res, next) => {
    const { imageId } = req.params;
    const reviewImage = await ReviewImage.findByPk(imageId)

    if (!reviewImage) {
        return res.status(404).json({
            message: "review image couldn't be found",
            statusCode: 404
        })
    }
    req.reviewImage = reviewImage;
    next();
};

router.delete('/:imageId', restoreUser, requireAuth, isImageExisting,
    async (req, res) => {
        const { spotImage, user } = req;
        const spot = await spotImage.getSpot();

        if (spot.ownerId !== user.id) {
            return res.status(403).json({
                message: "Forbidden",
                statusCode: 403
            });
        };

        await spotImage.destroy();

        res.json({
            message: "Successfully deleted",
            statusCode: 200
        });
    }
)

module.exports = router;
